#!/usr/bin/env python3
"""
Модуль для формирования промптов для тегирования обращений.

Содержит логику построения промптов с учетом существующих тегов,
форматирования обращений и инструкций для LLM.
"""

from typing import Optional


def build_tagging_prompt(
    base_prompt: str,
    requests: list[tuple[str, str]],
    existing_tags: Optional[dict[str, str]] = None,
    max_tags: int = 5,
    allow_new_tags: bool = True
) -> str:
    """
    Построить полный промпт для тегирования батча обращений.
    
    Args:
        base_prompt: Базовый промпт с инструкциями по тегированию
        requests: Список обращений в формате [(id, text), ...]
        existing_tags: Существующие теги {tag_name: description}
        max_tags: Максимальное количество тегов на обращение
        allow_new_tags: Разрешить создание новых тегов (по умолчанию True)
        
    Returns:
        Полный промпт для отправки в LLM
    """
    # Формируем промпт с существующими тегами
    existing_tags_text = ""
    if existing_tags:
        if allow_new_tags:
            existing_tags_text = "\n\nСуществующие теги (используй их если подходят):\n"
        else:
            existing_tags_text = "\n\nСуществующие теги (используй ТОЛЬКО их, не создавай новых):\n"
        for tag_name, description in existing_tags.items():
            existing_tags_text += f"- {tag_name}: {description}\n"
    
    # Формируем список обращений с XML-разметкой для четкого разделения
    requests_text = "\n".join([
        f'<request id="{req_id}">\n{req_text}\n</request>'
        for req_id, req_text in requests
    ])
    
    # Полный промпт с новым форматом ответа
    full_prompt = f"""{base_prompt}{existing_tags_text}

Обращения для тегирования (каждое обращение обернуто в XML теги с уникальным ID):
{requests_text}

Верни ТОЛЬКО валидный JSON объект в формате:
{{
  "results": [
    {{"id": "id1", "tags": ["тег1", "тег2"]}},
    {{"id": "id2", "tags": ["тег3"]}},
    ...
  ],
  "new_tags": {{
    "новый_тег1": "описание нового тега 1",
    "новый_тег2": "описание нового тега 2",
    ...
  }}
}}

Правила:
- В поле "results" должен быть массив объектов с полями "id" (строго соответствует ID из XML тега) и "tags" (массив строк)
- В поле "new_tags" должны быть ТОЛЬКО новые теги, которых нет в списке существующих тегов
- Максимум {max_tags} тегов на обращение
- Если тег определить невозможно, верни пустой массив tags: {{"id": "id1", "tags": []}}
{f"- НЕ создавай новые теги! Используй ТОЛЬКО теги из списка существующих тегов. Если подходящего тега нет, верни пустой массив tags." if not allow_new_tags else "- Ты должна создавать новые теги, если существующие не подходят"}
- Формируй теги на русском языке, используя только русские слова, без спецсимволов и без чисел
- В тегах пробел заменяй на нижнее подчеркивание, как и любые другие спецсимволы
- Старайся покрывать не менее 30% обращений
- Количество элементов в массиве "results" должно быть равно количеству обращений ({len(requests)})
- Каждый ID из "results" должен точно соответствовать ID из XML тега <request id="...">
- НЕ добавляй никакого текста до или после JSON объекта
"""
    
    return full_prompt

